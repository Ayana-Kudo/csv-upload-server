<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚µã‚¦ãƒ³ãƒ‰ã‚¦ã‚©ãƒ¼ã‚¯ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 40px auto; max-width: 600px; }
    input, textarea, button, select {
      font-size: 1rem; padding: 10px; margin: 8px; width: 90%; max-width: 500px;
    }
    .screen, .surveyPage { display: none; }
    #video, #previewImage { width: 90%; max-width: 400px; margin: 10px 0; }
    #progressContainer { width: 100%; background: #ddd; height: 10px; margin: 20px 0; }
    #progressBar { height: 100%; width: 0%; background: #4caf50; transition: width 0.4s; }
  </style>
</head>
<body>

<!-- ğŸš€ ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
<div id="startScreen" class="screen" style="display: block;">
  <h1>ã‚µã‚¦ãƒ³ãƒ‰ã‚¦ã‚©ãƒ¼ã‚¯</h1>
  <button onclick="goToInput()">å§‹ã‚ã‚‹</button>
</div>

<!-- ğŸ“ å…¥åŠ›ç”»é¢ -->
<div id="inputScreen" class="screen">
  <h2>åå‰ãƒ»æ€§åˆ¥ãƒ»å¹´é½¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h2>
   <input type="text" id="name" placeholder="åå‰"><br>
   <select id="gender">
     <option value="">æ€§åˆ¥ã‚’é¸ã‚“ã§ãã ã•ã„</option>
     <option value="ç”·æ€§">ç”·æ€§</option>
     <option value="å¥³æ€§">å¥³æ€§</option>
   </select><br>
   <input type="number" id="age" placeholder="å¹´é½¢"><br>
   <button onclick="requestPermissions()">æ¬¡ã¸</button>
</div>

<!-- ğŸ“· æ’®å½±ç”»é¢ -->
<div id="cameraScreen" class="screen">
  <h2>æ’®å½±ã—ã¦ãã ã•ã„</h2>
  <video id="video" autoplay playsinline></video><br>
  <canvas id="canvas" style="display:none;"></canvas><br>
  <button onclick="capture()">æ’®å½±</button>
</div>

<!-- ğŸ–¼ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢ -->
<div id="previewScreen" class="screen">
  <h2>ã“ã®ç”»åƒã‚’ä½¿ç”¨ã—ã¾ã™ã‹ï¼Ÿ</h2>
  <img id="previewImage" src=""><br>
  <button onclick="goToSurvey()">ä½¿ç”¨ã™ã‚‹</button>
  <button onclick="retake()">å†æ’®å½±</button>
</div>

<!-- ğŸ“ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆç”»é¢ -->
<div id="surveyScreen" class="screen">
  <h2>éŸ³ã«é–¢ã™ã‚‹ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</h2>
  <div id="progressContainer"><div id="progressBar"></div></div>

  <!-- Q1 -->
  <div id="q1Page" class="surveyPage">
    <h3>Q1. ä½•ã®éŸ³ã§ã™ã‹ï¼Ÿ</h3>
    <textarea id="q1" rows="4" placeholder="è‡ªç”±ã«ç­”ãˆã¦ãã ã•ã„..."></textarea><br>
    <button onclick="nextSurveyPage()">æ¬¡ã¸</button>
  </div>

  <!-- Q2 -->
  <div id="q2Page" class="surveyPage">
    <h3>Q2. éŸ³ã®è©•ä¾¡ã¯ï¼Ÿ</h3>
    <label><input type="radio" name="q2" value="è‰¯ã„"> è‰¯ã„</label><br>
    <label><input type="radio" name="q2" value="æ‚ªã„"> æ‚ªã„</label><br>
    <label><input type="radio" name="q2" value="ã©ã¡ã‚‰ã§ã‚‚ãªã„"> ã©ã¡ã‚‰ã§ã‚‚ãªã„</label><br>
    <button onclick="prevSurveyPage()">æˆ»ã‚‹</button>
    <button onclick="nextSurveyPage()">æ¬¡ã¸</button>
  </div>

  <!-- Q3 -->
  <div id="q3Page" class="surveyPage">
   <h3 id="q3Prompt" style="text-align: left;">Q3.</h3>
   <textarea id="q3" rows="4" placeholder="ç†ç”±ã‚’è‡ªç”±ã«ã”è¨˜å…¥ãã ã•ã„..."></textarea>
    <button onclick="prevSurveyPage()">æˆ»ã‚‹</button>
    <button onclick="nextSurveyPage()">æ¬¡ã¸</button>
  </div>
  
  <!-- Q4 -->
  <div id="q4Page" class="surveyPage">
    <h3 id="q4Prompt" style="text-align: left;">Q4.</h3>
    <textarea id="q4" rows="4" placeholder="..."></textarea><br>
    <button onclick="prevSurveyPage()">æˆ»ã‚‹</button>
    <button onclick="completeSurvey()">å®Œäº†</button>
  </div>

</div>

<!-- âœ… å®Œäº†ç”»é¢ -->
<div id="doneScreen" class="screen">
  <h2>å…¥åŠ›ãŒå®Œäº†ã—ã¾ã—ãŸï¼</h2>
  <p>ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚</p>
  <button onclick="location.reload()">æœ€åˆã«æˆ»ã‚‹</button>
</div>

<script>
let latitude = null, longitude = null, weather = "ä¸æ˜";
let currentSurvey = 1;
const totalSurvey = 4;

function goToInput() {
  switchScreen("inputScreen");
}

function requestPermissions() {
  const name = document.getElementById("name").value.trim();
  const gender = document.getElementById("gender").value;
  const age = document.getElementById("age").value.trim();

  if (!name || !gender || !age) {
    alert("åå‰ãƒ»æ€§åˆ¥ãƒ»å¹´é½¢ã™ã¹ã¦ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

    navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
    document.getElementById("video").srcObject = stream;
    switchScreen("cameraScreen");
  }).catch(() => {
    alert("ã‚«ãƒ¡ãƒ©ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“");
  });
}

  navigator.geolocation.getCurrentPosition(pos => {
    latitude = pos.coords.latitude;
    longitude = pos.coords.longitude;
    getWeather();
  });

  navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
    document.getElementById("video").srcObject = stream;
    switchScreen("cameraScreen");
  }).catch(() => {
    alert("ã‚«ãƒ¡ãƒ©ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“");
  });
}

function getWeather() {
  const apiKey = "ã“ã“ã«APIã‚­ãƒ¼"; // â˜…å¤©æ°—å–å¾—ã«ã¯ã‚­ãƒ¼ãŒå¿…è¦
  fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${latitude}&lon=${longitude}&appid=${apiKey}&units=metric&lang=ja`)
    .then(res => res.json())
    .then(data => {
      weather = `${data.weather[0].description}ï¼ˆ${data.main.temp}â„ƒï¼‰`;
    });
}

function switchScreen(id) {
  document.querySelectorAll(".screen").forEach(el => el.style.display = "none");
  document.getElementById(id).style.display = "block";
}

function capture() {
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(video, 0, 0);
  ctx.fillStyle = "white";
  ctx.font = "20px sans-serif";
  ctx.fillText(`${name} / ${gender} / ${age}æ­³`, 10, 30);
  ctx.fillText(weather, 10, 60);

  document.getElementById("previewImage").src = canvas.toDataURL("image/png");
  switchScreen("previewScreen");
}

function retake() {
  switchScreen("cameraScreen");
}

function goToSurvey() {
  switchScreen("surveyScreen");
  showSurveyPage(1);
}

function showSurveyPage(id) {
  document.querySelectorAll(".surveyPage").forEach(p => p.style.display = "none");
  const el = document.getElementById(`q${id}Page`);
  if (el) el.style.display = "block";

  currentSurvey = id;
  document.getElementById("progressBar").style.width = `${(id / totalSurvey) * 100}%`;

  if (id === 3) {
    const q1 = document.getElementById("q1").value.trim();
    const q2 = document.querySelector('input[name="q2"]:checked')?.value || "";
    document.getElementById("q3Template").innerText = `Q3.ã€Œ${q1}ã€ãŒã€Œ${q2}ã€ã¨æ„Ÿã˜ãŸç†ç”±ã¯ä½•ã§ã™ã‹ï¼Ÿ`;
  }

ã€€if (id === 4) {
  ã€€const q2 = document.querySelector('input[name="q2"]:checked')?.value || "";
 ã€€ const q3 = document.getElementById("q3").value.trim();
  ã€€document.getElementById("q4Prompt").innerText = `Q4. ãªãœã€Œ${q3}ã€ã ã¨ã€Œ${q2}ã€ã¨æ€ã†ã®ã§ã™ã‹ï¼Ÿ`;
ã€€}

}

function nextSurveyPage() {
  if (currentSurvey < totalSurvey) {
    showSurveyPage(currentSurvey + 1);
  }
}

function prevSurveyPage() {
  if (currentSurvey > 1) {
    showSurveyPage(currentSurvey - 1);
  }
}

function completeSurvey() {
  const q1 = document.getElementById("q1").value.trim();
  const q2 = document.querySelector('input[name="q2"]:checked')?.value || "";
  const q3 = document.getElementById("q3").value.trim();
ã€€const q4 = document.getElementById("q4").value.trim();
  const imageData = document.getElementById("canvas").toDataURL("image/png");

  // ä¿å­˜ï¼šã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå†…å®¹
  const text = `åå‰ï¼š${document.getElementById("name").value}\nç·¯åº¦çµŒåº¦ï¼š${latitude}, ${longitude}\nå¤©æ°—ï¼š${weather}\n\nQ1ï¼š${q1}\nQ2ï¼š${q2}\nQ3ï¼š${q3}Q4ï¼š${q4}`;//
  const blob = new Blob([text], {type: "text/plain"});
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `å›ç­”_${Date.now()}.txt`;
  link.click();

  // ä¿å­˜ï¼šç”»åƒ
  const a = document.createElement("a");
  a.href = imageData;
  a.download = `ç”»åƒ_${Date.now()}.png`;
  a.click();

  // ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰é€ä¿¡å‡¦ç†
  fetch("https://csv-upload-api-vcnd.onrender.com/upload", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      name: document.getElementById("name").value,
      lat: latitude,
      lon: longitude,
      weather: weather,
      image: imageData,
      q1: q1, q2: q2, q3: q3, q4: q4
    })
  }).then(res => res.text()).then(msg => console.log("é€ä¿¡æˆåŠŸ:", msg)).catch(err => alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼: " + err));

  switchScreen("doneScreen");
}
</script>

</body>
</html>